---
# Tasks for testing role
- name: Configure sandbox environment
  hosts: localhost
  roles:
    - role: amtega.vagrant_presets
      vagrant_presets_boxes_json_query: >-
        [? starts_with(name, `centos-7`)
           || starts_with(name, `fedora-29`)
           || starts_with(name, `fedora-30`) ]
  tags:
    - sandbox

- name: Setup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vagrant_sandbox_state: started
  tags:
    - sandbox

- name: Test apache role
  hosts: vagrant_sandbox_vms
  roles:
      - role: amtega.apache
  tasks:
    - name: Check that apache is listening
      wait_for:
        port: "{{ item }}"
        timeout: 10
      loop:
        - "{{ apache_httpd_port }}"
        - "{{ apache_ssl_port }}"

    - name: Check that http port returns welcome page
      uri:
        url: "http://localhost:{{ apache_httpd_port }}"
        return_content: yes
      register: check_httpd_result
      failed_when: >-
         not check_httpd_result.content
             is search("Apache Web Server was installed by ansible")
    - name: Check that ssl port returns welcome page
      uri:
        url: "https://localhost:{{ apache_ssl_port }}"
        return_content: yes
        validate_certs: no
      register: check_ssl_result
      failed_when: >-
         not check_ssl_result.content
             is search("Apache Web Server was installed by ansible")
  tags:
    - idempotence

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vagrant_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
